{% extends 'base.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container my-4">
  <h1 class="mb-4">Editar Objeto</h1>

  {% if error %}
  <div class="alert alert-danger" role="alert">{{ error }}</div>
  {% endif %}

  <form method="POST" id="edit-object-form">
    {% csrf_token %}

    <!-- -------------------------
             Selección de valores comunes
        ------------------------- -->
    <div class="border rounded p-3 mb-3">
      <h5>Habitación, Lugar y Cajón</h5>

      <div class="mb-3 row g-2 align-items-center">
        <div class="col-md-10">
          <label for="common-room" class="form-label">Habitación</label>
          <select id="common-room" name="common_room" class="form-select">
            <option value="">--Selecciona habitación--</option>
            {% for room in user_rooms %}
            <option value="{{ room.id }}" {% if obj.placelabel and obj.placelabel.room.id == room.id %}selected{% endif %}>
              {{ room.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal"
            data-bs-target="#newRoomModal">+</button>
        </div>
      </div>

      <div class="mb-3 row g-2 align-items-center">
        <div class="col-md-10">
          <label for="common-place" class="form-label">Lugar</label>
          <select id="common-place" name="common_place" class="form-select">
            <option value="">--Selecciona lugar--</option>
            {% for place in user_places %}
            <option value="{{ place.id }}" {% if obj.placelabel and obj.placelabel.id == place.id %}selected{% endif %}>
              {{ place.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal"
            data-bs-target="#newPlaceModal">+</button>
        </div>
      </div>

      <div class="mb-3 row g-2 align-items-center">
        <div class="col-md-10">
          <label for="common-box" class="form-label">Cajón (opcional)</label>
          <select id="common-box" name="common_box" class="form-select">
            <option value="">--Selecciona cajón--</option>
            {% for box in user_boxes %}
            <option value="{{ box.id }}" {% if obj.boxlabel and obj.boxlabel.id == box.id %}selected{% endif %}>
              {{ box.name }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2 d-flex align-items-end">
          <button type="button" class="btn btn-warning w-100" data-bs-toggle="modal"
            data-bs-target="#newBoxModal">+</button>
        </div>
      </div>
    </div>

    <!-- -------------------------
             Campos individuales para editar
        ------------------------- -->
    <div class="border rounded p-3 mb-3">
      <h5>Datos del objeto</h5>
      <div class="row g-2">
        <div class="col-md-3">
          <input type="text" id="obj-name" name="name" class="form-control" placeholder="Nombre del objeto"
            value="{{ obj.name }}">
        </div>
        <div class="col-md-3">
          <textarea id="obj-desc" name="description" class="form-control" placeholder="Descripción"
            rows="1">{{ obj.description }}</textarea>
        </div>
        <div class="col-md-3">
          <select id="obj-type" name="type" class="form-select">
            <option value="">--Tipo--</option>
            {% for t in user_types %}
            <option value="{{ t.id }}" {% if obj.label and obj.label.id == t.id %}selected{% endif %}>
              {{ t.typename }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-3 d-flex align-items-center">
          <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#newTypeModal">+</button>
        </div>
      </div>

      <div class="form-check mt-2">
        <input type="checkbox" id="obj-important" name="important" class="form-check-input" {% if obj.important %}checked{% endif %}>
        <label class="form-check-label" for="obj-important">¿Es importante?</label>
      </div>

      <div class="row g-2 mt-2">
        <div class="col-md-6">
          <input type="text" id="obj-who" name="whoIsIt" class="form-control" placeholder="Propietario"
            value="{{ obj.whoIsIt }}">
        </div>
        <div class="col-md-6">
          <input type="text" id="obj-hasit" name="hasIt" class="form-control" placeholder="¿Se lo prestaste a...?"
            value="{{ obj.hasIt }}">
        </div>
      </div>

      <div class="form-check mt-2">
        <input type="checkbox" id="obj-isinplace" name="isInPlace" class="form-check-input" {% if obj.isInPlace %}checked{% endif %}>
        <label class="form-check-label" for="obj-isinplace">¿Está en su lugar?</label>
      </div>
    </div>

    <button type="submit" class="btn btn-primary">Guardar cambios</button>
  </form>
</div>


<!-- ---------------------------
     MODALES
--------------------------- -->
<!-- Nuevo Lugar -->
<div class="modal fade" id="newPlaceModal" tabindex="-1" aria-labelledby="newPlaceLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="new-place-form">
        <div class="modal-header">
          <h5 class="modal-title" id="newPlaceLabel">Nuevo Lugar</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="place-name" class="form-control mb-2" placeholder="Nombre del lugar">
          <textarea id="place-desc" class="form-control mb-2" placeholder="Descripción"></textarea>

          <select id="place-room" class="form-select mb-2" required>
            <option value="">Selecciona una habitación</option>
            {% for room in user_rooms %}
            <option value="{{ room.id }}">{{ room.name }}</option>
            {% endfor %}
          </select>

          <div id="place-error" class="text-danger mt-1" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="savePlaceBtn">Guardar Lugar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Nuevo Tipo -->
<div class="modal fade" id="newTypeModal" tabindex="-1" aria-labelledby="newTypeLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="new-type-form">
        <div class="modal-header">
          <h5 class="modal-title" id="newTypeLabel">Nuevo Tipo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="type-name" class="form-control" placeholder="Nombre del tipo">
          <div id="type-error" class="text-danger mt-1" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-warning" id="saveTypeBtn">Guardar Tipo</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Nueva Habitación -->
<div class="modal fade" id="newRoomModal" tabindex="-1" aria-labelledby="newRoomLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="new-room-form">
        <div class="modal-header">
          <h5 class="modal-title" id="newRoomLabel">Nueva Habitación</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="text" id="room-name" class="form-control" placeholder="Nombre de la habitación">
          <div id="room-error" class="text-danger mt-1" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="saveRoomBtn">Guardar Habitación</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Nuevo Cajón -->
<div class="modal fade" id="newBoxModal" tabindex="-1" aria-labelledby="newBoxLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="new-box-form">
        <div class="modal-header">
          <h5 class="modal-title" id="newBoxLabel">Nuevo Cajón</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select id="box-place" class="form-select mb-2">
            <option value="">Selecciona un lugar</option>
            {% for place in user_places %}
            <option value="{{ place.id }}">{{ place.name }}</option>
            {% endfor %}
          </select>
          <input type="text" id="box-name" class="form-control" placeholder="Nombre del cajón (opcional)">
          <div id="box-error" class="text-danger mt-1" style="display:none;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-dark" id="saveBoxBtn">Guardar Cajón</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // ------------------- AJAX NUEVA HABITACIÓN -------------------
  document.getElementById('saveRoomBtn').addEventListener('click', function () {
    const name = document.getElementById('room-name').value.trim();
    const errorDiv = document.getElementById('room-error');
    errorDiv.style.display = 'none';
    if (!name) {
      errorDiv.textContent = "El nombre es obligatorio";
      errorDiv.style.display = 'block';
      return;
    }

    fetch("{% url 'create_room_ajax' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const selectMain = document.getElementById('common-room');
          const optionMain = document.createElement('option');
          optionMain.value = data.id;
          optionMain.text = data.name;
          optionMain.selected = true;
          selectMain.add(optionMain);

          const selectPlaceModal = document.getElementById('place-room');
          const optionModal = document.createElement('option');
          optionModal.value = data.id;
          optionModal.text = data.name;
          selectPlaceModal.add(optionModal);

          const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('newRoomModal'));
          modal.hide();
          document.getElementById('room-name').value = '';
        } else {
          errorDiv.textContent = data.error;
          errorDiv.style.display = 'block';
        }
      });
  });

  // ------------------- AJAX NUEVO LUGAR -------------------
  document.getElementById('savePlaceBtn').addEventListener('click', function () {
    const name = document.getElementById('place-name').value.trim();
    const desc = document.getElementById('place-desc').value.trim();
    const roomId = document.getElementById('place-room').value;
    const errorDiv = document.getElementById('place-error');
    errorDiv.style.display = 'none';

    if (!name) { errorDiv.textContent = "El nombre es obligatorio"; errorDiv.style.display = 'block'; return; }
    if (!roomId) { errorDiv.textContent = "Debes seleccionar una habitación"; errorDiv.style.display = 'block'; return; }

    fetch("{% url 'create_place_ajax' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name, description: desc, room_id: roomId })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const selectMain = document.getElementById('common-place');
          const optionMain = document.createElement('option');
          optionMain.value = data.id;
          optionMain.text = data.name;
          optionMain.selected = true;
          selectMain.add(optionMain);

          const selectBoxModal = document.getElementById('box-place');
          const optionModal = document.createElement('option');
          optionModal.value = data.id;
          optionModal.text = data.name;
          selectBoxModal.add(optionModal);

          const modal = bootstrap.Modal.getInstance(document.getElementById('newPlaceModal'));
          modal.hide();
          document.getElementById('place-name').value = '';
          document.getElementById('place-desc').value = '';
          document.getElementById('place-room').value = '';
        } else {
          errorDiv.textContent = data.error;
          errorDiv.style.display = 'block';
        }
      });
  });

  // ------------------- AJAX NUEVO TIPO -------------------
  document.getElementById('saveTypeBtn').addEventListener('click', function () {
    const name = document.getElementById('type-name').value.trim();
    const errorDiv = document.getElementById('type-error');
    errorDiv.style.display = 'none';
    if (!name) { errorDiv.textContent = "El nombre es obligatorio"; errorDiv.style.display = 'block'; return; }

    fetch("{% url 'create_objtype_ajax' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
      body: JSON.stringify({ typename: name })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const select = document.getElementById('obj-type');
          const option = document.createElement('option');
          option.value = data.id;
          option.text = data.name;
          option.selected = true;
          select.add(option);

          const modal = bootstrap.Modal.getInstance(document.getElementById('newTypeModal'));
          modal.hide();
          document.getElementById('type-name').value = '';
        } else {
          errorDiv.textContent = data.error;
          errorDiv.style.display = 'block';
        }
      });
  });

  // ------------------- AJAX NUEVO CAJÓN -------------------
  document.getElementById('saveBoxBtn').addEventListener('click', function () {
    const placeId = document.getElementById('box-place').value;
    const name = document.getElementById('box-name').value.trim();
    const errorDiv = document.getElementById('box-error');
    errorDiv.style.display = 'none';
    if (!placeId) { errorDiv.textContent = "Debes seleccionar un lugar"; errorDiv.style.display = 'block'; return; }

    fetch("{% url 'create_box_ajax' %}", {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' },
      body: JSON.stringify({ place: placeId, name: name })
    })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const select = document.getElementById('common-box');
          const option = document.createElement('option');
          option.value = data.id;
          option.text = data.name;
          option.selected = true;
          select.add(option);

          const modal = bootstrap.Modal.getInstance(document.getElementById('newBoxModal'));
          modal.hide();
          document.getElementById('box-name').value = '';
          document.getElementById('box-place').value = '';
        } else {
          errorDiv.textContent = data.error;
          errorDiv.style.display = 'block';
        }
      });
  });

  // ------------------- MULTI OBJETOS CON TODOS SUS CAMPOS -------------------
  let objects = [];

  function renderList() {
    const ul = document.getElementById('object-list');
    ul.innerHTML = '';
    objects.forEach((obj, index) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.textContent = obj.name + (obj.description ? ' - ' + obj.description : '');
      const btn = document.createElement('button');
      btn.className = 'btn btn-sm btn-danger';
      btn.textContent = '✖';
      btn.onclick = () => { objects.splice(index, 1); renderList(); };
      li.appendChild(btn);
      ul.appendChild(li);
    });
  }

  document.getElementById('add-object-btn').addEventListener('click', () => {
    const name = document.getElementById('obj-name').value.trim();
    if (!name) return alert("El nombre es obligatorio");

    const objData = {
      name: name,
      description: document.getElementById('obj-desc').value.trim(),
      type: document.getElementById('obj-type').value,
      important: document.getElementById('obj-important').checked,
      whoIsIt: document.getElementById('obj-who').value.trim(),
      hasIt: document.getElementById('obj-hasit').value.trim(),
      isInPlace: document.getElementById('obj-isinplace').checked,
      placelabel: document.getElementById('common-place').value,
      boxlabel: document.getElementById('common-box').value
    };

    objects.push(objData);
    renderList();

    document.getElementById('obj-name').value = '';
    document.getElementById('obj-desc').value = '';
    document.getElementById('obj-type').value = '';
    document.getElementById('obj-important').checked = false;
    document.getElementById('obj-who').value = 'Yo';
    document.getElementById('obj-hasit').value = 'Yo';
    document.getElementById('obj-isinplace').checked = true;
  });

  document.getElementById('objects-form').addEventListener('submit', (e) => {
    if (objects.length === 0) {
      e.preventDefault();
      alert("Agrega al menos un objeto antes de guardar");
      return;
    }

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'objects_data';
    input.value = JSON.stringify(objects);
    e.target.appendChild(input);
  });

  // ------------------- SELECTS ENCADENADOS CON PRESELECCIÓN -------------------
  const roomSelect = document.getElementById("common-room");
  const placeSelect = document.getElementById("common-place");
  const boxSelect = document.getElementById("common-box");

  // valores enviados desde Django
  const preselectedRoom = "{{ preselected.room|default:'' }}";
  const preselectedPlace = "{{ preselected.place|default:'' }}";
  const preselectedBox = "{{ preselected.box|default:'' }}";

  // Deshabilitar de inicio
  placeSelect.disabled = true;
  boxSelect.disabled = true;

  // Preseleccionar habitación al cargar
  document.addEventListener("DOMContentLoaded", function () {
    if (preselectedRoom) {
      roomSelect.value = preselectedRoom;
      roomSelect.dispatchEvent(new Event("change"));
    }
  });

  roomSelect.addEventListener("change", function () {
    const roomId = this.value;
    placeSelect.innerHTML = '<option value="">--Selecciona lugar--</option>';
    boxSelect.innerHTML = '<option value="">--Selecciona cajón--</option>';
    boxSelect.disabled = true;

    if (roomId) {
      fetch(`/ajax/places/${roomId}/`)
        .then(res => res.json())
        .then(data => {
          data.forEach(place => {
            let opt = document.createElement("option");
            opt.value = place.id;
            opt.textContent = place.name;
            placeSelect.appendChild(opt);
          });
          placeSelect.disabled = false;

          // si hay lugar preseleccionado
          if (preselectedPlace) {
            placeSelect.value = preselectedPlace;
            placeSelect.dispatchEvent(new Event("change"));
          }
        });
    } else {
      placeSelect.disabled = true;
    }
  });

  placeSelect.addEventListener("change", function () {
    const placeId = this.value;
    boxSelect.innerHTML = '<option value="">--Selecciona cajón--</option>';

    if (placeId) {
      fetch(`/ajax/boxes/${placeId}/`)
        .then(res => res.json())
        .then(data => {
          data.forEach(box => {
            let opt = document.createElement("option");
            opt.value = box.id;
            opt.textContent = box.name;
            boxSelect.appendChild(opt);
          });
          boxSelect.disabled = false;

          // si hay cajón preseleccionado
          if (preselectedBox) {
            boxSelect.value = preselectedBox;
          }
        });
    } else {
      boxSelect.disabled = true;
    }
  });
</script>
{% endblock %}